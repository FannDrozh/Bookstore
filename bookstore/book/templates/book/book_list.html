{% extends 'book/base.html' %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥{% endblock %}

{% block content %}
<h1 class="mb-4">üìö –ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥</h1>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <input type="text" name="search" class="form-control"
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É..."
                       value="{{ request.GET.search }}">
            </div>
            <div class="col-md-3">
                <select name="genre" class="form-select">
                    <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
                    {% for value, label in view.model.GENRE_CHOICES %}
                    <option value="{{ value }}"
                            {% if request.GET.genre == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="sort_by" class="form-select">
                    <option value="-created_at" {% if request.GET.sort_by == '-created_at' %}selected{% endif %}>
                        –ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ)
                    </option>
                    <option value="title" {% if request.GET.sort_by == 'title' %}selected{% endif %}>
                        –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê-–Ø)
                    </option>
                    <option value="-title" {% if request.GET.sort_by == '-title' %}selected{% endif %}>
                        –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ø-–ê)
                    </option>
                    <option value="-rating" {% if request.GET.sort_by == '-rating' %}selected{% endif %}>
                        –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
                    </option>
                    <option value="-price_rub" {% if request.GET.sort_by == '-price_rub' %}selected{% endif %}>
                        –ü–æ —Ü–µ–Ω–µ (–¥–æ—Ä–æ–≥–∏–µ)
                    </option>
                    <option value="price_rub" {% if request.GET.sort_by == 'price_rub' %}selected{% endif %}>
                        –ü–æ —Ü–µ–Ω–µ (–¥–µ—à–µ–≤—ã–µ)
                    </option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="alert alert-info">
    –ù–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥: <strong>{{ total_books }}</strong>
    {% if recent_books %}
    ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ:
    {% for book in recent_books %}
    <a href="{% url 'book:book_detail' book.pk %}">{{ book.title }}</a>{% if not forloop.last %}, {% endif %}
    {% endfor %}
    {% endif %}
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∫–Ω–∏–≥ -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ê–≤—Ç–æ—Ä</th>
                <th>–ñ–∞–Ω—Ä</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                <th>–ì–æ–¥</th>
                <th>–ù–∞–ª–∏—á–∏–µ</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <td>
                    <strong>{{ book.title }}</strong>
                    {% if book.isbn %}
                    <br><small class="text-muted">ISBN: {{ book.isbn }}</small>
                    {% endif %}
                </td>
                <td>{{ book.author }}</td>
                <td>
                    <span class="badge bg-primary">
                        {{ book.get_genre_display }}
                    </span>
                </td>
                <td class="text-end">
                    <strong>{{ book.price_rub }} ‚ÇΩ</strong>
                </td>
                <td>
                    {% if book.rating %}
                    <div class="text-warning">
                        {% with ''|center:book.rating as range %}
                        {% for _ in range|slice:":5" %}‚òÖ{% endfor %}
                        {% endwith %}
                        <small class="text-muted">({{ book.rating }})</small>
                    </div>
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if book.publication_year %}
                    {{ book.publication_year }}
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if book.is_available %}
                    <span class="badge bg-success">–í –Ω–∞–ª–∏—á–∏–∏</span>
                    {% else %}
                    <span class="badge bg-danger">–ù–µ—Ç</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'book:book_detail' book.pk %}"
                           class="btn btn-outline-primary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                            üëÅÔ∏è
                        </a>
                        <a href="{% url 'book:book_update' book.pk %}"
                           class="btn btn-outline-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </a>
                        <a href="{% url 'book:book_delete' book.pk %}"
                           class="btn btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                            üóëÔ∏è
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="alert alert-warning">
                        –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                        <a href="{% url 'book:book_create' %}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–Ω–∏–≥—É</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if is_paginated %}
<nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                –ü–µ—Ä–≤–∞—è
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                –ù–∞–∑–∞–¥
            </a>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
            <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                {{ num }}
            </a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                –í–ø–µ—Ä–µ–¥
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                –ü–æ—Å–ª–µ–¥–Ω—è—è
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<div class="mt-4 text-center">
    <a href="{% url 'book:book_create' %}" class="btn btn-success btn-lg">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
    </a>
</div>
{% endblock %}